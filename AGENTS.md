# AGENTS.md — heic_ready / Codex 指示

## プロダクトの定義

heic_ready は、macOS 上で指定フォルダに入った HEIC/HEIF 画像を
ユーザー操作なしで「どこでも使える形式（JPEG）」へ準備する常駐ユーティリティである。

ユーザーは変換という概念を意識しない。
「AirDropしたら、そのまま添付できる」を保証する。

## ゴール体験

1. iPhone → AirDrop
2. Mac にファイルが届く
3. そのまま Web に添付できる

ユーザーはアプリを開かない
変換ボタンを押さない
保存先を探さない

## 非ゴール

このアプリは以下を提供しない

* 画像管理 / ギャラリー
* 編集機能（トリミング・回転・補正）
* クラウドアップロード
* Webサービス
* AI機能
* バッチ変換UI

重くなる機能は入れない

## 技術方針

* Rust をコアとする
* Tauri を UI とトレイ用途にのみ使用
* 変換処理は OS のデコーダを使用（macOS ImageIO）
* 常駐アプリとして CPU 使用率を最小化
* フォアグラウンドウィンドウは基本持たない

## コア機能（MVP）

### フォルダ監視

* 複数フォルダを監視可能
* 再帰監視はデフォルトOFF
* notify crate を利用

### 安定化判定（必須）

ファイルが完全に書き込み終わってから処理する

実装要件：

* イベント受信後すぐ処理しない
* サイズが一定時間（300ms）変化しないことを確認
* 最大3回リトライ

### 変換処理

入力:

* .heic
* .heif

出力:

* .jpg

仕様:

* EXIF orientation を正しく反映
* 色空間を崩さない
* OS デコード利用

### 原子的書き込み

以下を必ず守る：

1. *.tmp に書き込む
2. 書き込み完了後 rename
3. その後に元ファイル処理

破損ファイルを絶対に作らない

### 同名衝突

既存ファイルを上書きしない

例:
IMG_0001.heic → IMG_0001.jpg
既に存在 → IMG_0001 (1).jpg

### 出力ポリシー

* coexist: HEIC残す + JPG生成（デフォルト）
* replace: HEICをゴミ箱へ移動

## スレッドモデル

監視スレッドとワーカースレッドを分離

監視 → キュー投入 → worker処理

同一パスのイベントはデバウンス

並列数: 最大2

トレイメニューのみ

* Running / Paused
* Pause / Resume
* Settings
* Quit

設定画面：

* 監視フォルダ
* 出力ポリシー
* JPEG品質

## 設定保存

JSON ファイル
app config directory 配下

## ログ

直近10件のみ保持
成功/失敗/スキップ理由を記録

## テスト要件

正常系:

* HEIC投入でJPEG生成
* 複数同時でも破損しない
* Finder表示前に完了

異常系:

* 書き込み途中は処理しない
* 権限不足を検知
* ロックファイルをスキップ

## 設計上の禁止事項

* 即時変換（安定化なし）
* 直接上書き
* HEIC削除を先に行う
* UI依存の処理
* 監視と変換の同期処理

## マイルストーン

M0: Tauriトレイ + 設定保存
M1: フォルダ監視 + 安定化
M2: HEIC→JPEG変換
M3: ポリシー実装
M4: 安定化・高速化

## 成功条件

ユーザーが「このアプリを意識しなくなる」こと

## Git 運用ルール

* 生成物・キャッシュ・ローカル環境依存ファイルなど、リポジトリに追加すべきでないものは必ず `.gitignore` に記載する
* 新しいツール導入時は、初回コミット前に無視対象を点検する
